#!/usr/bin/env node
const { readFileSync, writeFileSync } = require("fs");
const { spawnSync } = require("child_process");
const path = require("path");

if (!spawnSync("grep", ["-e", "webpack.common", "webpack.config.js"]).status) {
  return;
}

const config = require("./webpack.config");
if (typeof config.entry === "string") {
  config.entry = {
    index:config.entry
  };
}

if (!("index" in config.entry) && path.basename(__dirname) in config.entry) {
  config.entry.index = relDir("src/index.ts");
  delete config.entry[path.basename(__dirname)];
}

if (!("demo" in config.entry)) {
  config.entry.demo = relDir("src/demo.ts");
}

writeFileSync("webpack.config.js", `const {webpackConfig, relDir} = require("./webpack.common");

module.exports = {
  entry: {
${Object.keys(config.entry).map(entry=>{
  return `    ${entry}: relDir("${path.relative(".", config.entry[entry])}"),`
}).join("\n")}
  },
  ...webpackConfig(false),
};
`);

if (spawnSync("git", ["diff", "--quiet", "webpack.config.js"]).status) {
  console.log("webpack.config.js has changes");
  return;
}

